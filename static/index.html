<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot AI - Universal Tutor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Gemini Dark Palette */
      --bg: #131314;
      --surface: #1E1F20;
      --surface-2: #2D2E30;
      --line: #444746;
      
      --text-main: #E3E3E3;
      --text-sub: #C4C7C5;
      --text-muted: #8E918F;

      --accent-gradient: linear-gradient(135deg, #4b90ff, #ff5546);
      --accent-blue: #A8C7FA;
      
      --success: #6DD58C;
      --error: #F2B8B5;
      --warning: #FFD54F;
      
      --radius-l: 24px;
      --radius-m: 16px;

      --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      
      --font-body: 'Roboto', -apple-system, sans-serif;
      --font-head: 'Google Sans', 'Roboto', sans-serif;
      --mono: 'Menlo', 'Consolas', monospace;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text-main);
      font-family: var(--font-body);
      background-image: 
        radial-gradient(circle at 10% 10%, rgba(76, 141, 246, 0.05), transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(217, 101, 112, 0.05), transparent 40%);
      min-height: 100vh;
    }

    /* Layout */
    .app-layout {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
      padding: 20px;
      height: 100vh;
    }
    
    @media (max-width: 1000px) {
      .app-layout { grid-template-columns: 1fr; height: auto; }
      .chat-panel { height: 80vh; }
    }

    /* Typography */
    h1, h2, h3, .title { font-family: var(--font-head); }
    
    /* Header */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 5px;
    }
    .brand {
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-main);
    }
    .brand-icon {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      font-size: 22px; 
      margin-right: 4px;
    }
    .pill-badge {
      font-size: 11px;
      background: var(--surface-2);
      color: var(--text-sub);
      padding: 4px 10px;
      border-radius: 99px;
      font-family: var(--mono);
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--radius-l);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card-hd {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .card-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-main);
    }

    /* Chat Area */
    .msgs {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }
    .msg {
      max-width: 85%;
      line-height: 1.6;
      font-size: 15px;
      position: relative;
      word-break: break-word;
      white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ì§€ì› */
    }
    .msg.user {
      align-self: flex-end;
      background-color: var(--surface-2);
      color: var(--text-main);
      padding: 12px 18px;
      border-radius: 18px 18px 4px 18px;
    }
    .msg.bot {
      align-self: flex-start;
      padding: 0 10px 0 34px;
      color: var(--text-main);
    }
    .msg.bot::before {
      content: 'âœ¨';
      position: absolute;
      left: 0;
      top: 0;
      font-size: 18px;
    }

    /* Typing Animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 0;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background-color: var(--text-sub);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    .meta-info {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      font-family: var(--mono);
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .msg a {
      color: var(--accent-blue);
      text-decoration: none;
      border-bottom: 1px solid transparent; 
      transition: .2s;
    }
    .msg a:hover { border-bottom-color: var(--accent-blue); }
    
    /* Markdown Styles */
    .msg b, .msg strong { color: var(--success); font-weight: 700; }
    .msg h3, .msg h2, .msg h1 { margin: 12px 0 4px 0; font-size: 1.1em; color: var(--accent-blue); font-weight: 700; }

    /* Composer */
    .composer {
      background: var(--surface);
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .input-wrapper {
      background: var(--surface-2);
      border-radius: 28px;
      padding: 8px 8px 8px 20px;
      display: flex;
      align-items: flex-end;
      border: 1px solid transparent;
      transition: .2s;
    }
    .input-wrapper:focus-within {
      background: #252628;
      border-color: #555;
    }
    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 15px;
      font-family: var(--font-body);
      resize: none;
      outline: none;
      min-height: 24px;
      max-height: 120px;
      padding: 12px 0;
      line-height: 1.5;
    }

    /* Buttons */
    button {
      border: none;
      cursor: pointer;
      font-family: var(--font-head);
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 20px;
      transition: .2s;
    }
    .btn-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-main);
      color: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      padding: 0;
    }
    .btn-send:hover { opacity: 0.9; transform: scale(1.05); }
    .btn-send svg { width: 20px; height: 20px; fill: currentColor; }

    .btn-text { background: transparent; color: var(--text-sub); border: 1px solid var(--line); }
    .btn-text:hover { background: var(--surface-2); color: var(--text-main); }
    .btn-reset { color: var(--error); background: rgba(242, 184, 181, 0.05); }
    .btn-reset:hover { background: rgba(242, 184, 181, 0.1); }
    .btn-chip { background: rgba(168, 199, 250, 0.08); color: var(--accent-blue); }
    .btn-chip:hover { background: rgba(168, 199, 250, 0.15); }

    /* Controls Panel */
    .controls-panel {
      padding: 12px;
      overflow-y: auto; /* ì „ì²´ íŒ¨ë„ ìŠ¤í¬ë¡¤ */
      gap: 16px;
      display: flex;
      flex-direction: column;
      height: 100%; /* ë¶€ëª¨ ë†’ì´ ì±„ì›€ */
    }
    .section-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 4px;
    }
    input, select {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text-main);
      font-family: var(--font-body);
      font-size: 12px;
      height: 36px;
      outline: none;
      margin-bottom: 2px;
    }
    input:focus, select:focus {
      border-color: var(--accent-blue);
      background: #252628;
    }
    .help-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-left: 2px;
      line-height: 1.3;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    /* Debug Data Area - Fixed visibility */
    .debug-section {
      margin-top: auto; /* í•˜ë‹¨ìœ¼ë¡œ ë°€ê¸° */
      padding-top: 10px;
      border-top: 1px dashed var(--line);
    }
    .code-block {
      background: #000;
      border-radius: 12px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-sub);
      overflow: auto; 
      border: 1px solid var(--line);
      min-height: 100px;  /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
      max-height: 300px;
      resize: vertical; 
      white-space: pre-wrap; 
      margin-bottom: 8px;
    }
    .debug-header {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .status-dot.idle { background: var(--text-muted); }
    .status-dot.sending { background: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
    .status-dot.error { background: var(--error); }

    .drop-zone {
      border: 2px dashed var(--line);
      border-radius: var(--radius-m);
      padding: 16px;
      text-align: center;
      color: var(--text-sub);
      transition: .2s;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }
    .drop-zone.dragover {
      border-color: var(--accent-blue);
      background: rgba(168, 199, 250, 0.1);
      color: var(--accent-blue);
    }
    .drop-text { font-size: 12px; margin-top: 4px; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
  </style>
</head>

<body>

<div class="app-layout">
  
  <header>
    <div class="brand">
      <span class="brand-icon">ğŸª</span>
      Universal Tutor Console
    </div>
    <div class="pill-badge" id="endpointChip">http://localhost:8000/api/chat</div>
  </header>

  <div class="card chat-panel">
    <div class="card-hd">
      <span class="card-title">Session</span>
      <div style="display:flex; gap:8px;">
        <button class="btn-text btn-reset" id="btnClear">Clear</button>
        <button class="btn-text btn-chip" id="btnExamples">Random Prompt</button>
      </div>
    </div>

    <div class="msgs" id="msgs">
      <div class="msg bot" style="opacity:0.6;">
        ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.<br>
        <span class="meta-info">System Init</span>
      </div>
    </div>

    <div class="composer">
      <div class="input-wrapper">
        <textarea id="userMessage" rows="1" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (Enter to send)"></textarea>
        <button id="btnSend" class="btn-send">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding:0 4px;">
        <div style="font-size:12px; color:var(--text-muted); display:flex; align-items:center;">
          <span id="statusDot" class="status-dot idle"></span>
          <span id="statusText">Ready</span>
        </div>
        <div style="font-size:11px; color:var(--text-muted); font-family:var(--mono);">
          Trace: <span id="traceId">-</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-hd">
      <span class="card-title">Configuration</span>
      <div style="display:flex; gap:6px;">
        <button class="btn-text" id="btnPresetEdu" style="font-size:11px;">Reset Defaults</button>
      </div>
    </div>

    <div class="controls-panel">
      
      <div>
        <div id="pdfDropZone" class="drop-zone">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <div style="font-size:20px;">ğŸ“„</div>
            <div class="drop-text" id="dropText">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ RAG í•™ìŠµ</div>
          </div>
          <input type="file" id="pdfInput" accept=".pdf" style="display:none" />
        </div>
        <div class="help-text" style="text-align:center;">ì—…ë¡œë“œí•œ êµì¬ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.</div>
      </div>

      <div>
        <div class="section-label">Connection & Session</div>
        
        <input id="endpoint" value="http://localhost:8000/api/chat" placeholder="Endpoint URL" />
        <div class="help-text">ë°±ì—”ë“œ API ì£¼ì†Œì…ë‹ˆë‹¤.</div>
        
        <input id="clientSessionId" placeholder="Session ID (UUID)" />
        <div class="help-text">ì‚¬ìš©ì ì„¸ì…˜ ID (ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±)</div>

        <div class="grid-2">
            <div>
              <select id="platformId">
                <option value="web" selected>Web</option>
              </select>
              <div class="help-text">ì ‘ì† í”Œë«í¼</div>
            </div>
            <div>
              <select id="userId">
                <option value="user_1" selected>user_1</option>
              </select>
              <div class="help-text">ì‚¬ìš©ì ì‹ë³„ì</div>
            </div>
        </div>
        
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <select id="mode">
              <option value="Edu" selected>Edu</option>
            </select>
            <div class="help-text">ëŒ€í™” ëª¨ë“œ (êµìœ¡ìš© ë“±)</div>
          </div>
          <div>
            <select id="domain">
              <option value="education" selected>education</option>
            </select>
            <div class="help-text">ì„œë¹„ìŠ¤ ë„ë©”ì¸</div>
          </div>
        </div>
      </div>

      <div>
        <div class="section-label">User Context (í•„ìˆ˜)</div>
        
        <select id="userLevel">
            <option value="beginner">Beginner (ì´ˆë“±í•™ìƒ ëˆˆë†’ì´)</option>
            <option value="intermediate" selected>Intermediate (ì¤‘Â·ê³ ë“±í•™ìƒ)</option>
            <option value="advanced">Advanced (ëŒ€í•™ìƒ ì´ìƒ)</option>
        </select>
        <div class="help-text">ì‚¬ìš©ìì˜ ì§€ì‹ ìˆ˜ì¤€(Level)ì„ ì„¤ì •í•©ë‹ˆë‹¤.</div>

        <select id="userAgeGroup" style="margin-top:4px;">
            <option value="">Select Age Group...</option>
            <option value="child">Child (ì–´ë¦°ì´)</option>
            <option value="teen">Teen (ì²­ì†Œë…„)</option>
            <option value="adult" selected>Adult (ì„±ì¸)</option>
        </select>
        <div class="help-text">ì‚¬ìš©ìì˜ ì—°ë ¹ëŒ€(Age)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</div>

        <select id="subjectContext" style="margin-top:4px;">
          <option value="general">General (ììœ  ëŒ€í™”)</option>
          <option value="math">Mathematics (ìˆ˜í•™)</option>
          <option value="english">English (ì˜ì–´)</option>
          <option value="physics">Physics (ë¬¼ë¦¬í•™)</option>
          <option value="quantum">Quantum Mechanics (ì–‘ìì—­í•™)</option>
          <option value="history">History (ì—­ì‚¬)</option>
          <option value="coding">Coding (í”„ë¡œê·¸ë˜ë°)</option>
        </select>
        <div class="help-text">í˜„ì¬ í•™ìŠµ ì¤‘ì¸ ê³¼ëª©ì´ë‚˜ ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>

        <div class="grid-2">
          <div>
            <select id="deviceType">
              <option value="web">Web</option>
              <option value="mobile">Mobile</option>
            </select>
            <div class="help-text">ì ‘ì† ê¸°ê¸°</div>
          </div>
          <div>
            <select id="inputType">
              <option value="text">Text</option>
              <option value="voice">Voice</option>
            </select>
            <div class="help-text">ì…ë ¥ ë°©ì‹</div>
          </div>
        </div>
      </div>

      <div>
        <div class="section-label">Teacher Persona</div>
        
        <select id="toneStyle">
          <option value="">Tone (Default/None)</option>
          <option value="kind">Kind & Encouraging (ì¹œì ˆ)</option>
          <option value="strict">Strict & Concise (ì—„ê²©)</option>
          <option value="socratic">Socratic (ì§ˆë¬¸ ìœ ë„í˜•)</option>
          <option value="humorous">Humorous (ìœ ë¨¸ëŸ¬ìŠ¤)</option>
        </select>
        <div class="help-text">AI ì„ ìƒë‹˜ì˜ ë§íˆ¬ë‚˜ ì„±ê²©ì„ ì„¤ì •í•©ë‹ˆë‹¤.</div>
        
        <div class="grid-2">
           <div>
             <select id="nativeLang">
               <option value="">Native (Default)</option>
               <option value="ko">Korean</option>
               <option value="en">English</option>
             </select>
             <div class="help-text">ì‚¬ìš©ì ëª¨êµ­ì–´</div>
           </div>
           <div>
             <select id="targetExam">
               <option value="">Exam (None)</option>
               <option value="O-PIC">O-PIC</option>
               <option value="TOEIC">TOEIC</option>
             </select>
             <div class="help-text">ëª©í‘œ ì‹œí—˜</div>
           </div>
        </div>
        
        <select id="weakPoints" style="margin-top:4px;">
          <option value="">Weak points (None)</option>
          <option value="Grammar">Grammar</option>
          <option value="Vocabulary">Vocabulary</option>
          <option value="Listening">Listening</option>
        </select>
        <div class="help-text">ì¤‘ì ì ìœ¼ë¡œ ë³´ì™„í•  ì·¨ì•½ì ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <div class="debug-section">
        <div class="section-label">Debug Data</div>
        <div style="display:flex; flex-direction:column; gap:12px;">
          
          <div>
            <span class="debug-header" style="color:var(--accent-blue);">ğŸ“¤ Sent</span>
            <div class="code-block" id="reqJson">{}</div>
          </div>

          <div>
             <span class="debug-header" style="color:var(--success);">ğŸ“¥ Reply</span>
             <div class="code-block" id="replyJson">{}</div>
          </div>

          <div>
             <span class="debug-header" style="color:var(--text-sub);">ğŸ’¾ State</span>
             <div class="code-block" id="stateJson">{}</div>
          </div>

        </div>
      </div>

      <input id="locale" type="hidden" value="ko-KR">
      <input id="timezone" type="hidden" value="Asia/Seoul">
      <input id="siteNavDbPath" type="hidden" value="data/site_nav.sqlite3">
      <textarea id="extraMeta" style="display:none;"></textarea>

    </div>
  </div>

</div>

<script>
  const $ = (id) => document.getElementById(id);
  const storeKey = "chatbot_tutor_config_v12_age"; 

  function nowTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function uuidv4() {
    return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  function getOrInitSessionId() {
    let inputVal = $("clientSessionId").value.trim();
    if (inputVal) return inputVal; 
    let sid = sessionStorage.getItem("client_session_id");
    if (!sid) {
      sid = uuidv4();
      sessionStorage.setItem("client_session_id", sid);
    }
    $("clientSessionId").value = sid;
    return sid;
  }

  // Simple Markdown Formatter
  function formatMessage(text) {
    if (!text) return "";
    let out = text.replace(/^### (.*$)/gim, '<div style="font-weight:700; font-size:1.1em; margin-top:12px; margin-bottom:4px; color:var(--accent-blue);">$1</div>');
    out = out.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    out = out.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
    return out;
  }

  function addMsg(role, text, metaLine) {
    const el = document.createElement("div");
    el.className = "msg " + (role === "user" ? "user" : "bot");
    el.innerHTML = formatMessage(text || "");
    if (metaLine) {
      const meta = document.createElement("div");
      meta.className = "meta-info";
      meta.innerHTML = metaLine; 
      el.appendChild(meta);
    }
    $("msgs").appendChild(el);
    setTimeout(() => {
      $("msgs").scrollTo({ top: $("msgs").scrollHeight, behavior: 'smooth' });
    }, 10);
  }

  function showThinking() {
    const el = document.createElement("div");
    el.className = "msg bot";
    el.id = "thinking-bubble";
    el.innerHTML = `
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    $("msgs").appendChild(el);
    setTimeout(() => {
      $("msgs").scrollTo({ top: $("msgs").scrollHeight, behavior: 'smooth' });
    }, 10);
    return el;
  }

  function removeThinking() {
    const el = $("thinking-bubble");
    if (el) el.remove();
  }

  function setStatus(kind, text) {
    const dot = $("statusDot");
    const txt = $("statusText");
    dot.className = "status-dot " + (kind || "idle");
    txt.textContent = text;
  }

  function setJson(el, obj) {
    el.textContent = JSON.stringify(obj ?? {}, null, 2);
  }

  function buildMeta() {
    let extra = {};
    try {
      const raw = $("extraMeta").value.trim();
      if (raw) extra = JSON.parse(raw);
    } catch (e) {}

    const meta = {
      client_session_id: getOrInitSessionId(),
      
      platform_id: $("platformId").value.trim().toLowerCase(),
      mode: $("mode").value.trim().toLowerCase(), 
      device_type: $("deviceType").value.trim().toLowerCase(),
      input_type: $("inputType").value.trim().toLowerCase(),
      
      user_id: $("userId").value.trim(),
      domain: $("domain").value.trim(),
      locale: $("locale").value.trim(),
      timezone: $("timezone").value.trim(),
      
      user_level: $("userLevel").value.trim(),
      // âœ… [ì¶”ê°€] Age Group
      user_age_group: $("userAgeGroup").value.trim(),

      native_language: $("nativeLang").value.trim(),
      target_exam: $("targetExam").value.trim(),
      subject: $("subjectContext").value.trim(),
      tone_style: $("toneStyle").value.trim(),
      
      ...extra,
    };
    
    const wpRaw = $("weakPoints").value.trim();
    if (wpRaw) {
      meta.weak_points = wpRaw.split(",").map(s => s.trim()).filter(s => s);
    }

    meta.site_nav_db_path = $("siteNavDbPath").value.trim() || "data/site_nav.sqlite3";

    Object.keys(meta).forEach(k => {
      if (meta[k] === "" || meta[k] == null) delete meta[k];
    });
    return meta;
  }

  async function send() {
    const endpoint = $("endpoint").value.trim();
    $("endpointChip").textContent = endpoint;

    const inputEl = $("userMessage");
    const user_message = inputEl.value.trim();
    if (!user_message) return;

    inputEl.value = "";
    inputEl.style.height = 'auto'; 

    const meta = buildMeta();
    addMsg("user", user_message, `${nowTime()}`);
    setStatus("sending", "Thinking...");
    showThinking();

    const body = { user_message, meta };
    setJson($("reqJson"), body);
    saveState({ lastBody: body });

    try {
      const t0 = performance.now();
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const dt = Math.round(performance.now() - t0);
      
      const json = await res.json().catch(() => ({}));
      const trace = json?.trace_id || json?.detail?.trace_id || "-";
      $("traceId").textContent = trace;

      removeThinking();

      if (!res.ok) {
        const errDetail = json.detail ? JSON.stringify(json.detail) : "Unknown error";
        addMsg("bot", `Error ${res.status}: ${errDetail}`, `${dt}ms`);
        setStatus("error", "Error");
        setJson($("replyJson"), json);
        return;
      }

      const reply = json?.reply || {};
      const state = json?.state || {};
      const text = reply?.text ?? JSON.stringify(reply, null, 2);
      const intent = reply?.ui_hints?.intent || state?.active_intent || "-";
      
      let debugInfo = `<span style="color:var(--text-muted)">${dt}ms</span>`;
      debugInfo += ` â€¢ <span>${intent}</span>`;
      if (meta.mode) {
        if(meta.user_level) debugInfo += ` â€¢ <span style="color:var(--accent-blue)">${meta.user_level}</span>`;
        // âœ… [ì¶”ê°€] Age Group í‘œì‹œ
        if(meta.user_age_group) debugInfo += ` â€¢ <span style="color:var(--accent-blue)">${meta.user_age_group}</span>`;
      }
      if (meta.subject) {
        debugInfo += ` â€¢ <span style="color:var(--warning)">${meta.subject}</span>`;
      }
      if (reply?.ui_hints?.used_pdf_rag) {
        debugInfo += ` â€¢ <span style="color:var(--success); font-weight:bold;">ğŸ“„ PDF RAG</span>`;
      }

      addMsg("bot", text, debugInfo);
      setStatus("idle", "Ready");
      
      setJson($("replyJson"), reply);
      setJson($("stateJson"), state);
      saveState({ lastResponse: json });

    } catch (err) {
      removeThinking();
      addMsg("bot", "Network Error: " + String(err), nowTime());
      setStatus("error", "Network Error");
    }
  }

  function clearAll() {
    $("msgs").innerHTML = '<div class="msg bot" style="opacity:0.6;">ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br><span class="meta-info">System Reset</span></div>';
    $("reqJson").textContent = "{}";
    $("replyJson").textContent = "{}";
    $("stateJson").textContent = "{}";
    $("traceId").textContent = "-";
    setStatus("idle", "Ready");
  }

  function loadExamples() {
    const examples = [
      { mode:"edu", domain:"education", msg:"ì–‘ìì—­í•™ì´ ë­ì•¼?", subject:"quantum" },
      { mode:"edu", domain:"education", msg:"í”„ë‘ìŠ¤ í˜ëª…ì˜ ì›ì¸ ì•Œë ¤ì¤˜", subject:"history" },
      { mode:"edu", domain:"education", msg:"Python ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ë²•", subject:"coding" },
      { mode:"edu", domain:"education", msg:"Hello, nice to meet you.", subject:"english" },
    ];
    const pick = examples[Math.floor(Math.random() * examples.length)];
    $("mode").value = "Edu"; 
    $("domain").value = pick.domain;
    $("userMessage").value = pick.msg;
    if(pick.subject) $("subjectContext").value = pick.subject;
    presetEdu();
  }

  function presetEdu() {
    $("mode").value = "Edu"; 
    $("domain").value = "education";
    $("deviceType").value = "web";
    $("platformId").value = "web";
    $("userId").value = "user_1";
    $("userLevel").value = "intermediate";
    $("userAgeGroup").value = "adult"; // âœ… ê¸°ë³¸ê°’ ì„¤ì •
    $("toneStyle").value = "";
    $("nativeLang").value = ""; 
    $("targetExam").value = ""; 
    getOrInitSessionId(); 
  }

  const dropZone = $("pdfDropZone");
  const fileInput = $("pdfInput");
  const dropText = $("dropText");
  dropZone.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => { if (e.target.files.length) uploadFile(e.target.files[0]); });
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("dragover"); });
  dropZone.addEventListener("dragleave", () => { dropZone.classList.remove("dragover"); });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault(); dropZone.classList.remove("dragover");
    if (e.dataTransfer.files.length) uploadFile(e.dataTransfer.files[0]);
  });
  async function uploadFile(file) {
    if (file.type !== "application/pdf") { alert("PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
    dropText.innerHTML = `Uploading <b>${file.name}</b>...`;
    const formData = new FormData(); formData.append("file", file);
    try {
      const res = await fetch("/api/upload_pdf", { method: "POST", body: formData });
      const json = await res.json();
      if (res.ok) {
        dropText.innerHTML = `âœ… <b>${json.filename}</b> Loaded!<br>(${json.chunks} chunks)`;
        dropZone.style.borderColor = "var(--success)";
      } else { dropText.textContent = "Upload Failed"; }
    } catch (e) { console.error(e); dropText.textContent = "Error: " + e.message; }
  }

  function saveState(patch) {
    const cur = loadState();
    localStorage.setItem(storeKey, JSON.stringify({ ...(cur || {}), ...(patch || {}) }));
  }
  function loadState() {
    try { return JSON.parse(localStorage.getItem(storeKey)); } catch(e){ return null; }
  }
  function restore() {
    const st = loadState();
    if (!st || !st.lastBody?.meta) {
      getOrInitSessionId(); 
      return;
    }
    const m = st.lastBody.meta;
    if (m.platform_id) $("platformId").value = m.platform_id;
    if (m.user_id) $("userId").value = m.user_id;
    if (m.client_session_id) $("clientSessionId").value = m.client_session_id;
    
    $("mode").value = "Edu"; 
    
    if (m.user_level) $("userLevel").value = m.user_level;
    if (m.user_age_group) $("userAgeGroup").value = m.user_age_group; // âœ… ë³µêµ¬
    if (m.device_type) $("deviceType").value = m.device_type;
    if (m.native_language) $("nativeLang").value = m.native_language;
    if (m.target_exam) $("targetExam").value = m.target_exam;
    if (m.subject) $("subjectContext").value = m.subject;
    if (m.tone_style) $("toneStyle").value = m.tone_style;
    if (m.weak_points) $("weakPoints").value = m.weak_points.join(", ");
    
    getOrInitSessionId(); 
  }

  $("btnSend").addEventListener("click", send);
  $("btnClear").addEventListener("click", () => { clearAll(); saveState({}); });
  $("btnExamples").addEventListener("click", loadExamples);
  $("btnPresetEdu").addEventListener("click", presetEdu);
  const ta = $("userMessage");
  ta.addEventListener("input", function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
  ta.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });
  restore();
</script>
</body>
</html>