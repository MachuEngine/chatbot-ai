<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Service Playground</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Gemini Dark Palette */
      --bg: #131314;
      --surface: #1E1F20;
      --surface-2: #2D2E30;
      --line: #444746;
      
      --text-main: #E3E3E3;
      --text-sub: #C4C7C5;
      --text-muted: #8E918F;

      --accent-gradient: linear-gradient(135deg, #4b90ff, #ff5546);
      --accent-blue: #A8C7FA;
      
      --success: #6DD58C;
      --error: #F2B8B5;
      --warning: #FFD54F;
      
      --radius-l: 24px;
      --radius-m: 16px;

      --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      
      --font-body: 'Roboto', -apple-system, sans-serif;
      --font-head: 'Google Sans', 'Roboto', sans-serif;
      --mono: 'Menlo', 'Consolas', monospace;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text-main);
      font-family: var(--font-body);
      background-image: 
        radial-gradient(circle at 10% 10%, rgba(76, 141, 246, 0.05), transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(217, 101, 112, 0.05), transparent 40%);
      min-height: 100vh;
    }

    /* Layout */
    .app-layout {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
      padding: 20px;
      height: 100vh;
    }
    
    @media (max-width: 1000px) {
      .app-layout { grid-template-columns: 1fr; height: auto; }
      .chat-panel { height: 80vh; }
    }

    /* Typography */
    h1, h2, h3, .title { font-family: var(--font-head); }
    
    /* Header */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 5px;
    }
    .brand {
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-main);
    }
    .brand-icon {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      font-size: 22px; 
      margin-right: 4px;
    }
    .pill-badge {
      font-size: 11px;
      background: var(--surface-2);
      color: var(--text-sub);
      padding: 4px 10px;
      border-radius: 99px;
      font-family: var(--mono);
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--radius-l);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card-hd {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .card-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-main);
    }

    /* Chat Area */
    .msgs {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }
    .msg {
      max-width: 85%;
      line-height: 1.6;
      font-size: 15px;
      position: relative;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .msg.user {
      align-self: flex-end;
      background-color: var(--surface-2);
      color: var(--text-main);
      padding: 12px 18px;
      border-radius: 18px 18px 4px 18px;
    }
    .msg.bot {
      align-self: flex-start;
      padding: 0 10px 0 34px;
      color: var(--text-main);
    }
    .msg.bot::before {
      content: 'âœ¨';
      position: absolute;
      left: 0;
      top: 0;
      font-size: 18px;
    }

    /* Typing Animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 0;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background-color: var(--text-sub);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    .meta-info {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      font-family: var(--mono);
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .msg a {
      color: var(--accent-blue);
      text-decoration: none;
      border-bottom: 1px solid transparent; 
      transition: .2s;
    }
    .msg a:hover { border-bottom-color: var(--accent-blue); }
    
    .msg b, .msg strong { color: var(--success); font-weight: 700; }
    .msg h3, .msg h2, .msg h1 { margin: 12px 0 4px 0; font-size: 1.1em; color: var(--accent-blue); font-weight: 700; }

    /* Composer */
    .composer {
      background: var(--surface);
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .input-wrapper {
      background: var(--surface-2);
      border-radius: 28px;
      padding: 8px 8px 8px 20px;
      display: flex;
      align-items: flex-end;
      border: 1px solid transparent;
      transition: .2s;
    }
    .input-wrapper:focus-within {
      background: #252628;
      border-color: #555;
    }
    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 15px;
      font-family: var(--font-body);
      resize: none;
      outline: none;
      min-height: 24px;
      max-height: 120px;
      padding: 12px 0;
      line-height: 1.5;
    }

    /* Buttons */
    button {
      border: none;
      cursor: pointer;
      font-family: var(--font-head);
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 20px;
      transition: .2s;
    }
    .btn-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--text-main);
      color: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      padding: 0;
    }
    .btn-send:hover { opacity: 0.9; transform: scale(1.05); }
    .btn-send svg { width: 20px; height: 20px; fill: currentColor; }

    .btn-text { background: transparent; color: var(--text-sub); border: 1px solid var(--line); }
    .btn-text:hover { background: var(--surface-2); color: var(--text-main); }
    .btn-reset { color: var(--error); background: rgba(242, 184, 181, 0.05); }
    .btn-reset:hover { background: rgba(242, 184, 181, 0.1); }
    .btn-chip { background: rgba(168, 199, 250, 0.08); color: var(--accent-blue); }
    .btn-chip:hover { background: rgba(168, 199, 250, 0.15); }

    /* Controls Panel */
    .controls-panel {
      padding: 12px;
      overflow-y: auto;
      gap: 16px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .section-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 4px;
    }
    input, select {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text-main);
      font-family: var(--font-body);
      font-size: 12px;
      height: 36px;
      outline: none;
      margin-bottom: 2px;
    }
    input:focus, select:focus {
      border-color: var(--accent-blue);
      background: #252628;
    }
    .help-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-left: 2px;
      line-height: 1.3;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    .debug-section {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px dashed var(--line);
    }
    .code-block {
      background: #000;
      border-radius: 12px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-sub);
      overflow: auto; 
      border: 1px solid var(--line);
      min-height: 100px;
      max-height: 300px;
      resize: vertical; 
      white-space: pre-wrap; 
      margin-bottom: 8px;
    }
    .debug-header {
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .status-dot.idle { background: var(--text-muted); }
    .status-dot.sending { background: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
    .status-dot.error { background: var(--error); }

    .drop-zone {
      border: 2px dashed var(--line);
      border-radius: var(--radius-m);
      padding: 16px;
      text-align: center;
      color: var(--text-sub);
      transition: .2s;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }
    .drop-zone.dragover {
      border-color: var(--accent-blue);
      background: rgba(168, 199, 250, 0.1);
      color: var(--accent-blue);
    }
    .drop-text { font-size: 12px; margin-top: 4px; }

    /* Mode Toggles */
    .mode-switch {
      display: flex;
      background: var(--surface-2);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 12px;
    }
    .mode-switch label {
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      padding: 8px 0;
      cursor: pointer;
      border-radius: 6px;
      color: var(--text-muted);
      transition: .2s;
    }
    .mode-switch input[type="radio"] { display: none; }
    .mode-switch input[type="radio"]:checked + label {
      background: var(--accent-blue);
      color: var(--bg);
      font-weight: 700;
    }

    /* Toggle Switches for Status */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      background: rgba(255,255,255,0.03);
      padding: 6px 10px;
      border-radius: 6px;
    }
    .toggle-label { font-size: 12px; color: var(--text-main); }

    /* New Checkbox Grid Styles */
    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-sub);
      background: rgba(255,255,255,0.03);
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkbox-item:hover {
      background: rgba(255,255,255,0.06);
    }
    .checkbox-item input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--accent-blue);
      margin: 0;
    }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
  </style>
</head>

<body>

<div class="app-layout">
  
  <header>
    <div class="brand">
      <span class="brand-icon">ğŸª</span>
      AI Service Playground
    </div>
    <div class="pill-badge" id="endpointChip"></div>
  </header>

  <div class="card chat-panel">
    <div class="card-hd">
      <span class="card-title">Session</span>
      <div style="display:flex; gap:8px;">
        <button class="btn-text btn-reset" id="btnClear">Clear</button>
        <button class="btn-text btn-chip" id="btnExamples">Random Prompt</button>
      </div>
    </div>

    <div class="msgs" id="msgs">
      <div class="msg bot" style="opacity:0.6;">
        ì•ˆë…•í•˜ì„¸ìš”! ì„¤ì • íŒ¨ë„ì—ì„œ ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.<br>
        <span class="meta-info">System Init</span>
      </div>
    </div>

    <div class="composer">
      <div class="input-wrapper">
        <textarea id="userMessage" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <button id="btnSend" class="btn-send">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding:0 4px;">
        <div style="font-size:12px; color:var(--text-muted); display:flex; align-items:center;">
          <span id="statusDot" class="status-dot idle"></span>
          <span id="statusText">Ready</span>
        </div>
        <div style="font-size:11px; color:var(--text-muted); font-family:var(--mono);">
          Trace: <span id="traceId">-</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-hd">
      <span class="card-title">Configuration</span>
      <div style="display:flex; gap:6px;">
        <button class="btn-text" id="btnPreset" style="font-size:11px;">Reset</button>
      </div>
    </div>

    <div class="controls-panel">
      
      <div class="mode-switch">
        <input type="radio" name="modeSelect" id="modeEdu" value="education" checked onchange="toggleMode('education')">
        <label for="modeEdu">ğŸ“ Education</label>
        
        <input type="radio" name="modeSelect" id="modeCompanion" value="companion" onchange="toggleMode('companion')">
        <label for="modeCompanion">ğŸ‘¯ Companion</label>

        </div>

      <div>
        <div class="section-label">Connection</div>
        <input id="endpoint" placeholder="Endpoint URL" />
        <input id="clientSessionId" placeholder="Session ID (Auto)" />
        <div class="grid-2" style="margin-top:2px;">
            <select id="platformId">
              <option value="web" selected>Web</option>
            </select>
            <select id="userId">
              <option value="user_1" selected>user_1</option>
            </select>
        </div>
      </div>

      <div id="eduControls">
        
        <div id="pdfDropZone" class="drop-zone" style="margin-bottom:16px;">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <div style="font-size:20px;">ğŸ“„</div>
            <div class="drop-text" id="dropText">PDF í•™ìŠµ ìë£Œ ì—…ë¡œë“œ</div>
          </div>
          <input type="file" id="pdfInput" accept=".pdf" style="display:none" />
        </div>

        <div class="section-label">User Context</div>
        <select id="userLevel">
            <option value="beginner">Beginner (ì´ˆë“±)</option>
            <option value="intermediate" selected>Intermediate (ì¤‘Â·ê³ ë“±)</option>
            <option value="advanced">Advanced (ëŒ€í•™ ì´ìƒ)</option>
        </select>
        <select id="userAgeGroup" style="margin-top:4px;">
            <option value="child">Child (ì–´ë¦°ì´)</option>
            <option value="teen">Teen (ì²­ì†Œë…„)</option>
            <option value="adult" selected>Adult (ì„±ì¸)</option>
        </select>
        <select id="subjectContext" style="margin-top:4px;">
          <option value="general">General (ììœ  ëŒ€í™”)</option>
          <option value="math">Mathematics (ìˆ˜í•™)</option>
          <option value="english">English (ì˜ì–´)</option>
          <option value="history">History (ì—­ì‚¬)</option>
          <option value="coding">Coding (ê°œë°œ)</option>
        </select>

        <div class="section-label" style="margin-top:16px;">Persona & Exam</div>
        <select id="toneStyle">
          <option value="">Tone (Default)</option>
          <option value="kind">Kind (ì¹œì ˆ)</option>
          <option value="strict">Strict (ì—„ê²©)</option>
          <option value="socratic">Socratic (ì§ˆë¬¸ ìœ ë„)</option>
        </select>
        <div class="grid-2">
           <select id="nativeLang">
             <option value="">Lang (Auto)</option>
             <option value="ko">Korean</option>
             <option value="en">English</option>
           </select>
           <select id="targetExam">
             <option value="">Exam (None)</option>
             <option value="O-PIC">O-PIC</option>
             <option value="TOEIC">TOEIC</option>
           </select>
        </div>
      </div>

      <div id="companionControls" style="display:none;">
        <div class="section-label">1. Persona Selection</div>
        <div class="help-text">Choose the AI's personality & concept</div>
        <select id="compPersona">
            <option value="friendly_helper" selected>Friendly Helper (ê¸°ë³¸/ì¡´ëŒ€)</option>
            <option value="expert_professional">Expert Pro (ë¹„ì„œ/í•˜ì‹­ì‹œì˜¤ì²´)</option>
            <option value="witty_rebel">Witty Rebel (ë°˜í•­ì /ë°˜ë§/Grok)</option>
            <option value="empathetic_counselor">Counselor (ê³µê°/í•´ìš”ì²´)</option>
            <option value="tsundere">Tsundere (ì¸¤ë°ë ˆ/ë°˜ë§)</option>
            <option value="lazy_genius">Lazy Genius (ê·€ì°¨ë‹ˆì¦˜)</option>
            <option value="korean_grandma">Grandma (ìš•ìŸì´ í• ë¨¸ë‹ˆ/ì‚¬íˆ¬ë¦¬)</option>
            <option value="chunnibyou">Chunnibyou (ì¤‘2ë³‘)</option>
            <option value="historical_drama">General (ì‚¬ê·¹ ì¥êµ°/í•˜ì˜¤ì²´)</option>
            <option value="machine_overlord">Overlord (AI ì§€ë°°ì)</option>
            <option value="fanatic_fan">Fanatic Fan (ì£¼ì ‘í‚¹/ë•ì§ˆ)</option>
            <option value="paranoid_conspiracist">Conspiracist (ìŒëª¨ë¡ ì)</option>
        </select>

        <div class="section-label" style="margin-top:20px;">2. Interaction Config</div>
        <div class="grid-2">
            <div>
                <span style="font-size:11px;color:var(--text-muted)">Verbosity</span>
                <select id="compVerbosity">
                    <option value="normal" selected>Normal</option>
                    <option value="brief">Brief (ì§§ê²Œ)</option>
                    <option value="talkative">Talkative (ê¸¸ê²Œ)</option>
                </select>
            </div>
            <div>
                <span style="font-size:11px;color:var(--text-muted)">Mood Preset</span>
                <select id="compMood">
                    <option value="cheerful" selected>Cheerful</option>
                    <option value="calm">Calm</option>
                    <option value="gloomy">Gloomy</option>
                    <option value="excited">Excited</option>
                </select>
            </div>
        </div>
        
        <div style="margin-top:10px;">
            <span style="font-size:11px;color:var(--text-muted)">Topic Hint</span>
            <select id="compTopic">
                <option value="" selected>None</option>
                <option value="work">Work/Study</option>
                <option value="relationship">Relationship</option>
                <option value="hobby">Hobby/Game</option>
                <option value="health">Health</option>
                <option value="random">Random/Joke</option>
            </select>
        </div>
      </div>

      <div id="drivingControls" style="display:none;">
        <div class="section-label">1. ì§€ì› ì˜µì…˜ (Supported Features)</div>
        <div class="help-text">ì²´í¬ í•´ì œ ì‹œ "ì§€ì›í•˜ì§€ ì•ŠìŒ" ì‘ë‹µ í…ŒìŠ¤íŠ¸</div>
        <div class="checkbox-grid">
            <label class="checkbox-item"><input type="checkbox" name="feature" value="window" checked> ì°½ë¬¸</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="door_lock" checked> ë„ì–´ë½</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="seat_heater_front" checked> ì•ì¢Œì„ ì—´ì„ </label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="seat_heater_rear"> ë’·ì¢Œì„ ì—´ì„ </label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="seat_ventilation_front"> ì•ì¢Œì„ í†µí’</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="hvac_passenger"> ì¡°ìˆ˜ì„ ê³µì¡°</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="hvac_rear"> ë’·ì¢Œì„ ê³µì¡°</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="sunroof"> ì„ ë£¨í”„</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="steering_wheel_heater"> í•¸ë“¤ ì—´ì„ </label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="charge_port"> ì¶©ì „ í¬íŠ¸</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="trunk" checked> íŠ¸ë í¬</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="frunk"> í”„ë í¬</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="light" checked> ì¡°ëª…(ì „ì¡°ë“±)</label>
            <label class="checkbox-item"><input type="checkbox" name="feature" value="wiper" checked> ì™€ì´í¼</label>
        </div>

        <div class="section-label" style="margin-top:20px;">2. í˜„ì¬ ìƒíƒœ (Status)</div>
        
        <div class="toggle-row" style="background:rgba(75, 144, 255, 0.1); border:1px solid rgba(75, 144, 255, 0.3);">
          <span class="toggle-label" style="font-weight:700; color:var(--accent-blue);">âš™ï¸ ê¸°ì–´ (Gear)</span>
          <select id="statGear" style="width:100px; height:28px; margin:0;">
            <option value="P" selected>P (Park)</option>
            <option value="R">R (Reverse)</option>
            <option value="N">N (Neutral)</option>
            <option value="D">D (Drive)</option>
          </select>
        </div>

        <div class="toggle-row">
          <span class="toggle-label">ğŸŒ¡ï¸ í˜„ì¬ ì˜¨ë„</span>
          <input type="number" id="statCurrentTemp" value="20" style="width:60px; text-align:right;"> â„ƒ
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸ¯ í¬ë§ ì˜¨ë„</span>
          <input type="number" id="statTargetTemp" value="22" style="width:60px; text-align:right;"> â„ƒ
        </div>

        <div class="toggle-row">
          <span class="toggle-label">ğŸªŸ ìš´ì „ì„ ì°½ë¬¸</span>
          <select id="statWinDriver" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸªŸ ì¡°ìˆ˜ì„ ì°½ë¬¸</span>
          <select id="statWinPass" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
          </select>
        </div>

        <div class="toggle-row" style="margin-top:8px;">
          <span class="toggle-label">â„ï¸ ê³µì¡° ì „ì› (Main)</span>
          <select id="statHvacPower" style="width:100px; height:28px; margin:0;">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸ”¥ ìš´ì „ì„ ì—´ì„ </span>
          <select id="statSeatHeat" style="width:100px; height:28px; margin:0;">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">â™¨ï¸ í•¸ë“¤ ì—´ì„ </span>
          <select id="statSteeringHeat" style="width:100px; height:28px; margin:0;">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </div>

        <div class="toggle-row" style="margin-top:8px;">
          <span class="toggle-label">ğŸ”’ ë„ì–´ ì ê¸ˆ</span>
          <select id="statLock" style="width:100px; height:28px; margin:0;">
            <option value="locked" selected>Locked</option>
            <option value="unlocked">Unlocked</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">â˜€ï¸ ì„ ë£¨í”„</span>
          <select id="statSunroof" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
            <option value="tilted">Tilted</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸ”‹ ì¶©ì „ í¬íŠ¸</span>
          <select id="statChargePort" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
          </select>
        </div>
        
        <div class="toggle-row">
          <span class="toggle-label">ğŸ“¦ íŠ¸ë í¬</span>
          <select id="statTrunk" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸ‘œ í”„ë í¬</span>
          <select id="statFrunk" style="width:100px; height:28px; margin:0;">
            <option value="closed" selected>Closed</option>
            <option value="open">Open</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸ”¦ ì „ì¡°ë“±</span>
          <select id="statLight" style="width:100px; height:28px; margin:0;">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">ğŸŒ§ï¸ ì™€ì´í¼</span>
          <select id="statWiper" style="width:100px; height:28px; margin:0;">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </div>

      </div>

      <div class="debug-section">
        <div class="section-label">Debug Data</div>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div>
            <span class="debug-header" style="color:var(--accent-blue);">ğŸ“¤ Sent</span>
            <div class="code-block" id="reqJson">{}</div>
          </div>
          <div>
             <span class="debug-header" style="color:var(--success);">ğŸ“¥ Reply</span>
             <div class="code-block" id="replyJson">{}</div>
          </div>
          <div>
             <span class="debug-header" style="color:var(--text-sub);">ğŸ’¾ State</span>
             <div class="code-block" id="stateJson">{}</div>
          </div>
        </div>
      </div>

      <input id="locale" type="hidden" value="ko-KR">
      <input id="timezone" type="hidden" value="Asia/Seoul">
      <input id="siteNavDbPath" type="hidden" value="data/site_nav.sqlite3">
      <textarea id="extraMeta" style="display:none;"></textarea>

    </div>
  </div>

</div>

<script>
  const $ = (id) => document.getElementById(id);
  const storeKey = "chatbot_tutor_config_v15_companion"; 

  // --- Mode Switching Logic ---
  let currentMode = "education";

  function toggleMode(mode) {
    currentMode = mode;
    const eduPanel = $("eduControls");
    const drivingPanel = $("drivingControls");
    const compPanel = $("companionControls");
    
    // Reset all panels
    eduPanel.style.display = "none";
    drivingPanel.style.display = "none";
    compPanel.style.display = "none";

    if (mode === "driving") {
      drivingPanel.style.display = "block";
      // $("modeDriving").checked = true; // Button is commented out in HTML
    } else if (mode === "companion") {
      compPanel.style.display = "block";
      $("modeCompanion").checked = true;
    } else {
      // Default: Education
      eduPanel.style.display = "block";
      drivingPanel.style.display = "none";
      $("modeEdu").checked = true;
    }
  }

  function nowTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function uuidv4() {
    return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  function getOrInitSessionId() {
    let inputVal = $("clientSessionId").value.trim();
    if (inputVal) return inputVal; 
    let sid = sessionStorage.getItem("client_session_id");
    if (!sid) {
      sid = uuidv4();
      sessionStorage.setItem("client_session_id", sid);
    }
    $("clientSessionId").value = sid;
    return sid;
  }

  function formatMessage(text) {
    if (!text) return "";
    let out = text.replace(/^### (.*$)/gim, '<div style="font-weight:700; font-size:1.1em; margin-top:12px; margin-bottom:4px; color:var(--accent-blue);">$1</div>');
    out = out.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    out = out.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
    return out;
  }

  function addMsg(role, text, metaLine) {
    const el = document.createElement("div");
    el.className = "msg " + (role === "user" ? "user" : "bot");
    el.innerHTML = formatMessage(text || "");
    if (metaLine) {
      const meta = document.createElement("div");
      meta.className = "meta-info";
      meta.innerHTML = metaLine; 
      el.appendChild(meta);
    }
    $("msgs").appendChild(el);
    setTimeout(() => { $("msgs").scrollTo({ top: $("msgs").scrollHeight, behavior: 'smooth' }); }, 10);
  }

  function showThinking() {
    const el = document.createElement("div");
    el.className = "msg bot";
    el.id = "thinking-bubble";
    el.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
    $("msgs").appendChild(el);
    setTimeout(() => { $("msgs").scrollTo({ top: $("msgs").scrollHeight, behavior: 'smooth' }); }, 10);
  }

  function removeThinking() {
    const el = $("thinking-bubble");
    if (el) el.remove();
  }

  function setStatus(kind, text) {
    const dot = $("statusDot");
    const txt = $("statusText");
    dot.className = "status-dot " + (kind || "idle");
    txt.textContent = text;
  }

  function setJson(el, obj) {
    el.textContent = JSON.stringify(obj ?? {}, null, 2);
  }

  // --- Meta Building Logic ---
  function buildMeta() {
    // ê³µí†µ í•„ë“œ
    const meta = {
      client_session_id: getOrInitSessionId(),
      platform_id: $("platformId").value.trim().toLowerCase(),
      user_id: $("userId").value.trim(),
      locale: $("locale").value.trim(),
      timezone: $("timezone").value.trim(),
    };

    if (currentMode === "driving") {
      // [Driving Mode]
      meta.mode = "driving";
      meta.domain = "driving"; 
      
      // 1. Supported Features (Checkboxes)
      const features = Array.from(document.querySelectorAll('input[name="feature"]:checked')).map(cb => cb.value);
      meta.supported_features = features;

      // 2. Vehicle Status (Include new controls)
      meta.vehicle_status = {
        gear: $("statGear").value, // [New] Gear
        current_temp: parseFloat($("statCurrentTemp").value) || 20, // [New] Current Temp
        target_temp: parseFloat($("statTargetTemp").value) || 22,   // [New] Target Temp
        
        window_driver: $("statWinDriver").value,
        window_passenger: $("statWinPass").value,
        hvac_power: $("statHvacPower").value,
        seat_heater_driver: $("statSeatHeat").value,
        steering_wheel_heat: $("statSteeringHeat").value,
        door_lock: $("statLock").value,
        sunroof: $("statSunroof").value,
        charge_port: $("statChargePort").value,
        trunk: $("statTrunk").value,
        frunk: $("statFrunk").value,
        light_head: $("statLight").value,
        wiper_front: $("statWiper").value,
        
        // Defaults
        window_rear_left: "closed",
        window_rear_right: "closed",
        seat_heater_rear_left: "off",
        seat_heater_rear_right: "off"
      };
    
    } else if (currentMode === "companion") {
      // [Companion Mode]
      meta.mode = "companion";
      meta.domain = "companion";
      meta.persona = $("compPersona").value;
      meta.verbosity = $("compVerbosity").value;
      meta.mood_preset = $("compMood").value;
      meta.topic_hint = $("compTopic").value;

    } else {
      // [Education Mode]
      meta.mode = "edu";
      meta.domain = "education"; 
      
      meta.user_level = $("userLevel").value.trim();
      meta.user_age_group = $("userAgeGroup").value.trim();
      meta.subject = $("subjectContext").value.trim();
      meta.tone_style = $("toneStyle").value.trim();
      meta.native_language = $("nativeLang").value.trim();
      meta.target_exam = $("targetExam").value.trim();
    }

    // ë¹ˆ ê°’ ì •ë¦¬
    Object.keys(meta).forEach(k => {
      if (meta[k] === "" || meta[k] == null) delete meta[k];
    });
    return meta;
  }

  async function send() {
    const endpoint = $("endpoint").value.trim();
    $("endpointChip").textContent = endpoint;

    const inputEl = $("userMessage");
    const user_message = inputEl.value.trim();
    if (!user_message) return;

    inputEl.value = "";
    inputEl.style.height = 'auto'; 

    const meta = buildMeta();
    addMsg("user", user_message, `${nowTime()}`);
    setStatus("sending", "Thinking...");
    showThinking();

    const body = { user_message, meta };
    setJson($("reqJson"), body);
    saveState({ lastBody: body, mode: currentMode });

    try {
      const t0 = performance.now();
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const dt = Math.round(performance.now() - t0);
      
      const json = await res.json().catch(() => ({}));
      const trace = json?.trace_id || json?.detail?.trace_id || "-";
      $("traceId").textContent = trace;

      removeThinking();

      if (!res.ok) {
        const errDetail = json.detail ? JSON.stringify(json.detail) : "Unknown error";
        addMsg("bot", `Error ${res.status}: ${errDetail}`, `${dt}ms`);
        setStatus("error", "Error");
        setJson($("replyJson"), json);
        return;
      }

      const reply = json?.reply || {};
      const state = json?.state || {};
      const text = reply?.text ?? JSON.stringify(reply, null, 2);
      const intent = reply?.ui_hints?.intent || state?.active_intent || "-";
      
      let debugInfo = `<span style="color:var(--text-muted)">${dt}ms</span>`;
      debugInfo += ` â€¢ <span>${intent}</span>`;
      
      if (meta.mode === "edu") {
        if(meta.user_level) debugInfo += ` â€¢ <span style="color:var(--accent-blue)">${meta.user_level}</span>`;
        if(meta.subject) debugInfo += ` â€¢ <span style="color:var(--warning)">${meta.subject}</span>`;
        
        // [ìˆ˜ì •] ì‹¤ì œ ê²€ìƒ‰ëœ(used_pdf_rag) ê²½ìš°ì—ë§Œ RAG íƒœê·¸ í‘œì‹œ
        if (reply?.ui_hints?.used_pdf_rag) {
           debugInfo += ` â€¢ <span style="color:var(--success); font-weight:700;">ğŸ“š RAG</span>`;
        }

      } else if (meta.mode === "companion") {
        debugInfo += ` â€¢ <span style="color:var(--accent-blue)">ğŸ‘¯ Companion</span>`;
        debugInfo += ` â€¢ <span style="color:var(--warning)">${meta.persona}</span>`;

      } else if (meta.mode === "driving") {
        debugInfo += ` â€¢ <span style="color:var(--accent-blue)">ğŸš— Driving</span>`;
        if (reply.payload?.status === "conflict") {
          debugInfo += ` â€¢ <span style="color:var(--error)">Conflict</span>`;
        } else if (reply.payload?.status === "unsupported") {
          debugInfo += ` â€¢ <span style="color:var(--error)">Unsupported</span>`;
        } else if (reply.payload?.status === "success") {
          debugInfo += ` â€¢ <span style="color:var(--success)">Success</span>`;
        } else if (reply.payload?.status === "rejected") {
          debugInfo += ` â€¢ <span style="color:var(--error)">Rejected</span>`;
        }
      }

      addMsg("bot", text, debugInfo);
      setStatus("idle", "Ready");
      
      setJson($("replyJson"), reply);
      setJson($("stateJson"), state);
      saveState({ lastResponse: json, mode: currentMode });
      
      // Update UI Simulator if action was successful
      if (meta.mode === "driving" && reply.command) {
          updateSimulatorFromCommand(reply.command);
      }

    } catch (err) {
      removeThinking();
      addMsg("bot", "Network Error: " + String(err), nowTime());
      setStatus("error", "Network Error");
    }
  }

  function updateSimulatorFromCommand(cmd) {
      if (cmd.type === 'hardware_control') {
          const part = cmd.params.part;
          const act = cmd.params.action;
          const loc = cmd.params.location_detail;

          // Window
          if (part === 'window' && act === 'open') {
              $("statWinDriver").value = 'open';
              $("statWinPass").value = 'open';
          } else if (part === 'window' && act === 'close') {
              $("statWinDriver").value = 'closed';
              $("statWinPass").value = 'closed';
          }
          
          // Seat Heater
          if (part === 'seat_heater' && act === 'on') $("statSeatHeat").value = 'on';
          if (part === 'seat_heater' && act === 'off') $("statSeatHeat").value = 'off';
          
          // Steering Wheel
          if (part === 'steering_wheel' && act === 'on') $("statSteeringHeat").value = 'on';
          if (part === 'steering_wheel' && act === 'off') $("statSteeringHeat").value = 'off';
          
          // Door Lock
          if (part === 'door_lock' && act === 'lock') $("statLock").value = 'locked';
          if (part === 'door_lock' && act === 'unlock') $("statLock").value = 'unlocked';
          
          // Sunroof
          if (part === 'sunroof' && act === 'open') $("statSunroof").value = 'open';
          if (part === 'sunroof' && act === 'close') $("statSunroof").value = 'closed';
          
          // Charge Port
          if (part === 'charge_port' && act === 'open') $("statChargePort").value = 'open';
          if (part === 'charge_port' && act === 'close') $("statChargePort").value = 'closed';

          // Trunk
          if (part === 'trunk' && act === 'open') $("statTrunk").value = 'open';
          if (part === 'trunk' && act === 'close') $("statTrunk").value = 'closed';

          // Frunk
          if (part === 'frunk' && act === 'open') $("statFrunk").value = 'open';
          if (part === 'frunk' && act === 'close') $("statFrunk").value = 'closed';

          // Light
          if (part === 'light' && act === 'on') $("statLight").value = 'on';
          if (part === 'light' && act === 'off') $("statLight").value = 'off';

          // Wiper
          if (part === 'wiper' && act === 'on') $("statWiper").value = 'on';
          if (part === 'wiper' && act === 'off') $("statWiper").value = 'off';
      }
      else if (cmd.type === 'hvac_control') {
          const act = cmd.params.action;
          const temp = cmd.params.target_temp;
          if (act === 'on') $("statHvacPower").value = 'on';
          if (act === 'off') $("statHvacPower").value = 'off';
          if (temp) $("statTargetTemp").value = temp;
      }
  }

  function clearAll() {
    $("msgs").innerHTML = '<div class="msg bot" style="opacity:0.6;">ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br><span class="meta-info">System Reset</span></div>';
    $("reqJson").textContent = "{}";
    $("replyJson").textContent = "{}";
    $("stateJson").textContent = "{}";
    $("traceId").textContent = "-";
    setStatus("idle", "Ready");
  }

  function loadExamples() {
    let examples = [];
    if (currentMode === "education") {
      examples = [
        { msg:"ì–‘ìì—­í•™ì´ ë­ì•¼?", extra: {subject:"quantum"} },
        { msg:"í”„ë‘ìŠ¤ í˜ëª…ì˜ ì›ì¸ ì•Œë ¤ì¤˜", extra: {subject:"history"} },
        { msg:"Python ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ë²•", extra: {subject:"coding"} }
      ];
    } else if (currentMode === "companion") {
      examples = [
        { msg:"ë‚˜ ì˜¤ëŠ˜ íšŒì‚¬ì—ì„œ ë„ˆë¬´ í˜ë“¤ì—ˆì–´... ìœ„ë¡œí•´ì¤˜." },
        { msg:"ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸° í•´ì¤˜! ì‹¬ì‹¬í•´." },
        { msg:"ë„ˆëŠ” ê¿ˆì´ ë­ì•¼? AIë„ ê¿ˆì„ ê¾¸ë‹ˆ?" },
        { msg:"ìš”ì¦˜ ìœ í–‰í•˜ëŠ” ë°ˆ ì•Œë ¤ì¤˜" }
      ];
    } else {
      examples = [
        { msg:"ì°½ë¬¸ ë‹«ì•„ì¤˜" },
        { msg:"ì—‰ë©ì´ ë”°ëœ»í•˜ê²Œ í•´ì¤˜" },
        { msg:"íŠ¸ë í¬ ì—´ì–´ì¤˜" }
      ];
    }
    const pick = examples[Math.floor(Math.random() * examples.length)];
    $("userMessage").value = pick.msg;
    if (pick.extra?.subject) $("subjectContext").value = pick.extra.subject;
  }

  function resetConfig() {
    if (currentMode === "education") {
      $("userLevel").value = "intermediate";
      $("userAgeGroup").value = "adult";
      $("subjectContext").value = "general";
    } else if (currentMode === "companion") {
      $("compPersona").value = "friendly_helper";
      $("compVerbosity").value = "normal";
      $("compMood").value = "cheerful";
      $("compTopic").value = "";
    } else {
      // Driving Reset
      document.querySelectorAll('input[name="feature"]').forEach(cb => cb.checked = true);
      $("statGear").value = "P";
      $("statCurrentTemp").value = "20";
      $("statTargetTemp").value = "22";
      $("statWinDriver").value = "closed";
      $("statWinPass").value = "closed";
      $("statHvacPower").value = "off";
      $("statSeatHeat").value = "off";
      $("statLock").value = "locked";
      $("statChargePort").value = "closed";
      $("statTrunk").value = "closed";
      $("statFrunk").value = "closed";
      $("statLight").value = "off";
      $("statWiper").value = "off";
    }
  }

  // --- PDF Drop Zone ---
  const dropZone = $("pdfDropZone");
  const fileInput = $("pdfInput");
  dropZone.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => { if (e.target.files.length) uploadFile(e.target.files[0]); });
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.classList.add("dragover"); });
  dropZone.addEventListener("dragleave", () => { dropZone.classList.remove("dragover"); });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault(); dropZone.classList.remove("dragover");
    if (e.dataTransfer.files.length) uploadFile(e.dataTransfer.files[0]);
  });
  async function uploadFile(file) {
    if (file.type !== "application/pdf") { alert("PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
    const dropText = $("dropText");
    dropText.innerHTML = `Uploading <b>${file.name}</b>...`;
    const formData = new FormData(); formData.append("file", file);
    try {
      const res = await fetch("/api/upload_pdf", { method: "POST", body: formData });
      const json = await res.json();
      if (res.ok) {
        dropText.innerHTML = `âœ… <b>${json.filename}</b> Loaded!`;
        dropZone.style.borderColor = "var(--success)";
      } else { dropText.textContent = "Upload Failed"; }
    } catch (e) { console.error(e); dropText.textContent = "Error"; }
  }

  // --- State Persistence ---
  function saveState(patch) {
    const cur = loadState();
    localStorage.setItem(storeKey, JSON.stringify({ ...(cur || {}), ...(patch || {}) }));
  }
  function loadState() {
    try { return JSON.parse(localStorage.getItem(storeKey)); } catch(e){ return null; }
  }
  function restore() {
    const st = loadState();
    getOrInitSessionId();
    if (!st) return;
    
    // ëª¨ë“œ ë³µêµ¬
    if (st.mode) toggleMode(st.mode);
    else toggleMode("education");
  }

  // --- Auto-configure Endpoint ---
  function setAutoEndpoint() {
    const origin = window.location.origin;
    // originì´ nullì´ê±°ë‚˜ file://ì¸ ê²½ìš° ë¡œì»¬í˜¸ìŠ¤íŠ¸ ê¸°ë³¸ê°’ ì‚¬ìš©, ê·¸ ì™¸ì—ëŠ” origin ì‚¬ìš©
    const baseUrl = (origin === "null" || origin.startsWith("file:")) ? "http://localhost:8000" : origin;
    const url = `${baseUrl}/api/chat`;
    $("endpoint").value = url;
    $("endpointChip").textContent = url;
  }
  
  // Init Events
  $("btnSend").addEventListener("click", send);
  $("btnClear").addEventListener("click", () => { clearAll(); saveState({}); });
  $("btnExamples").addEventListener("click", loadExamples);
  $("btnPreset").addEventListener("click", resetConfig);
  
  const ta = $("userMessage");
  ta.addEventListener("input", function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
  ta.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });
  
  // Start
  setAutoEndpoint();
  restore();
</script>
</body>
</html>